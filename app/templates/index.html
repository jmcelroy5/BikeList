{% extends 'base.html' %}

{% block scripts %}
	<!-- Mapbox -->
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
	<script src="{{ url_for('static',filename='js/jquery.nouislider.all.min.js') }}"></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
	<link href="{{ url_for('static',filename='css/jquery.nouislider.css') }}" rel="stylesheet">

{% endblock %}

{% block content %}
<style>
body{
	margin-left:-53px;
}

#map-panel{
	width: 430px;
	float:left;
	top:70px;
	left:0;
	bottom:0;
    position: fixed;
    margin-bottom:0px;
    overflow:hidden;
  }


#search-results li {
	display: inline-block;
	width: 32%;
	vertical-align: top;
	margin-bottom: 20px;
}

#search-panel img{
	width: 200px;
	width: 90%;
	margin-right: 30px;
	margin-bottom: 15px;
}

#search-filters{
 	height: 288px;
 	width: 634px;
 	margin-top:-130px;
 	top: 0;
 	/*background-color: #f6f6f6;*/
 }

.filter-group{
	padding: 10px;
	border-bottom:1px dotted #cecece;
}

input[type=number]{
    width: 60px;
} 

#content{
    width: 1100px;
	margin-top: 75px;
}
#range{
	margin-top: 10px;
	margin-bottom:10px;
}

#slider-right{
	float:right;
}

.myBtn:hover,
.myBtn:active,
.myBtn:focus {
	background-color:#fff
}

.invisible{
	visibility: hidden;
}

.marker-popup {
	font-size:14px;
}

.marker-popup img{
	width: 100px;
}

.img {
    position: relative;
    float: left;
    width:  194px;
    height: 133px;
    background-position: 50% 50%;
    background-repeat:   no-repeat;
    background-size:     cover;
    margin-bottom: 3px;
    margin-top:10px;
    border-radius: 5px;
}

.pricetag{
	width:50px;
	height:25px;
	z-index: 0.5;
	background-color: #494949;
	opacity: 0.9;
	position: absolute;
	bottom:0;
	color: white;
	text-align: right;
	padding:3px;
}

.heart {
	text-align: right;
	font-size: 20px;
	float: right;
	margin-right: 30px;
	margin-top: 0px;
}

/* Empty heart  */
.fa-heart-o{
	color: #d8cec0;
}

.fa-heart{
	color: #ff85db;
}

/*#sticky-bar.affix{
	margin-top:0px;
	top: 72px;
	z-index: 1;
	margin-left: -34px;
	width: 768px;
	padding:10px;
}

#sticky-bar {
	margin-left: -34px;
	background-color: #ffffff;
	border-bottom: 1px dotted #cecece;
	margin-top: -15px;
	text-align: right;
}
*/

#filter-btn-bar{
	margin-top: -15px;
	text-align: right;
	padding: 10px;
	width: 634px;
}

#search-panel{
	float:right;
	width: 650px;
}

#search-results{
	width:650px;
	list-style-type: none;
	padding: 0;
	overflow: auto;
}

.btn-default:hover, .btn-default:active{
	background-color: white;
}

#limit-map-search {
	background-color: white;
	color: rgb(82, 77, 77);
	font-size: 12;
	margin-left: 45px;
	/*width: 246px;*/
	width: 177px;
	padding: 8px;
	bottom: 21px;
	position: fixed;
}

#next, #prev, #search-panel, #filter-clear{
	color: #4d4d4d;
}

</style>

<div id="content">
	
	<div id="map-panel"  class="col-lg-6">
		<!-- class="col-md-8" -->
	</div>
	<div id="limit-map-search"><input name="search-by-map" type="checkbox"> &nbsp; Search when I move map</div>

	<div id="search-panel" class="col-lg-6">
		<div id="search-filters">

			<form id="filter-knobs" action= "#">
				<div id="size-filters" class="filter-group">
					<strong>Frame Size</strong><br>
					<input name="xs" type="checkbox">  Xsmall  </input>
					<input name="s" type="checkbox">  Small  </input>
					<input name="m" type="checkbox">  Medium  </input>
					<input name="l" type="checkbox">  Large  </input>
					<input name="xl" type="checkbox">  Xlarge  </input>
					<!-- <input name="Wood or organic material" type="checkbox">Wood/Bamboo</input>  -->
				</div>
				<div id="materials-filters" class="filter-group">
					<strong>Frame Material</strong><br>
					<input name="Titanium" type="checkbox">  Titanium</input>
					<input name="Carbon or composite" type="checkbox">  Carbon Fiber</input>
					<input name="Aluminum" type="checkbox">  Aluminum</input>
					<input name="Steel" type="checkbox">  Steel</input>
					<!-- <input name="Wood or organic material" type="checkbox">Wood/Bamboo</input>  -->
				</div>
				<div id="handlebar-filters" class="filter-group">
					<strong>Handlebar Type</strong><br>
					<input name="Drop" type="checkbox">  Drop</input>
					<input name="Flat" type="checkbox">  Flat</input>
					<input name="Forward facing" type="checkbox">  Forward-facing</input>
					<input name="Rear facing" type="checkbox">  Rear-facing</input>
					<!-- <input name="Not handlebars" type="checkbox">Not handlebars</input>
				<input name="BMX style" type="checkbox">BMX-style</input> -->
				</div>
				<div id="price-filters" class="filter-group">
					<strong>Price</strong><br>
<!-- 						Min: $ <input name="min_price" type="number"></input>
					Max: $ <input name="max_price" type="number"></input> -->
					<div id="range"></div>
					Min: $<span id="value-low"></span>
					<span id="slider-right">Max: $<span id="value-high"></span></span>
					<br>
				</div>
			</form>
		</div>
		<div id="search-results-wrapper">
			<div id="filter-btn-bar">
				<button class= "btn btn-default" id="filter-clear">Clear Filters</button>
				<button class= "btn btn-primary" id="filter-submit">Apply Filters</button>
			</div>

			<ul id="search-results">
				<!-- Listings populate here -->
			</ul>

			<div id="paginator">
				
				<button class="btn btn-default myBtn" id="prev"><span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span> &nbsp; Previous</button> 
				&nbsp;&nbsp;&nbsp;&nbsp; 
				Showing <span id="low"></span> - <span id="high"></span> of <span id="total"></span> results
				&nbsp;&nbsp;&nbsp;&nbsp; 
	 			<button class="btn btn-default myBtn" id="next">Next <span class="glyphicon glyphicon-arrow-right"></span> </button>
				
			</div><br>
		</div>
	</div>
</div>
			
<script>

// Models

var events = new MicroEvent();

var searchParameters = {
	sizes: [],
	materials: [],
	handlebars: [],
	maxPrice: null,
	minPrice: null,

	latitudeMin: null,
	latitudeMax: null,
	longitudeMin: null,
	longitudeMax: null,

	// searchOnMapMove: false,

	resultLimit: 15,
	currentPage: 0, 
}

var currentUser = {
	id: null,
	avatar: null,
	name: null,
	favorites: []
}

// where should this function go?
$.get('/getuser', function(data){
	currentUser.id = data.user;
	currentUser.avatar = data.avatar;
	currentUser.name = data.name;
	currentUser.favorites = data.favorites;
});

function getParameter(key){		
	return searchParameters[key];	
}

function setParameter(key, value){
	searchParameters[key] = value;
	// events.trigger('parameter-update');
}

var results = {
	results: [],
	numResults: null,
	pageLower: null,
	pageUpper: null,
	totalResults: null,
}

function fetchResults(callback){
	$.get('/getbikes', searchParameters, callback);
	// fetches the bikes for current searchParameters
	// once it has that data, calls callback function
}

events.on('parameter-update', function() {
	fetchResults(function(data){
		updateResults(data);
	});
});

// callback function for fetchResults
function updateResults(data){
	var response = data["response"];
	results.results = response["listings"]; // array of listings
	results.numResults = response["num_results"];  // length of listings array
	results.pageLower = response["page_range_lower"]; // lower bound of items to display
	results.pageUpper = response["page_range_upper"]; // lower bound of items to display
	results.totalResults = response["total_results"];
	results.favorites = response["favorites"];

	// trigger results-update so search panel, pagination, and listings update
	events.trigger('results-update', currentPage = searchParameters["currentPage"]);
}

// Views

function Map(el) { 
	this.el = el;

	this.initialize();

	events.on('results-update', function() {
		// Clear any markers that are on map 
		if (typeof this.markerLayer !== 'undefined'){
			this.markerLayer.clearLayers();
		} 
		// Place new markers
		this.placeMarkers(results);
	}.bind(this));

	events.on('listing-mouse-in', function(listingId) {
		this.setMarkerActive(listingId);
	}.bind(this));
	// Another way: events.on('listing-mouse-in', this.setMarkerActive.bind(this));

	events.on('listing-mouse-out', function(listingId) {
		this.setMarkerInactive(listingId);
	}.bind(this));
	// Another way: events.on('listing-mouse-out', this.setMarkerInactive.bind(this));

	// User can choose whether they want map move to trigger search
	$("#limit-map-search input:checkbox").change(function(){
		if ($(this).is(':checked')){
			window.map.enableMapSearch();
		}
		else{
			window.map.disableMapSearch();
		}
	});
}

Map.prototype.getViewCoords = function(){
	setParameter('latitudeMin', this.map.getBounds().getSouth());
	setParameter('latitudeMax', this.map.getBounds().getNorth());
	setParameter('longitudeMin', this.map.getBounds().getWest());
	setParameter('longitudeMax', this.map.getBounds().getEast());
	setParameter('currentPage',0)
	events.trigger('parameter-update');
}

Map.prototype.enableMapSearch = function(){
	this.map.on('dragend', this.getViewCoords.bind(this));
	this.map.on('zoomend', this.getViewCoords.bind(this));
	setParameter("searchOnMapMove",true);
	events.trigger('parameter-update');
}

Map.prototype.disableMapSearch = function(){
	this.map.off('dragend');
	this.map.off('zoomend');
	setParameter('latitudeMin', null);
	setParameter('latitudeMax', null);
	setParameter('longitudeMin', null)
	setParameter('longitudeMax', null);
	setParameter("searchOnMapMove", false);
	events.trigger('parameter-update');
}

Map.prototype.initialize = function() {
	//Connect to MapBox API
	L.mapbox.accessToken = "pk.eyJ1Ijoiam1jZWxyb3kiLCJhIjoiVVg5eHZldyJ9.FFzKtamuKHb_8_b_6fAOFg";

	// Initialize map 
	this.map = L.mapbox.map(this.el, 'asdv.ka97lo0j', { zoomControl: false });

	// // Set starting view/zoom(SF)
	// this.map.setView([37.78, -122.44], 13);
	
	// Set zoom control location
	new L.Control.Zoom({ position: 'bottomleft' }).addTo(this.map);
	// Add geocoder search bar
	this.map.addControl(L.mapbox.geocoderControl('mapbox.places-v1'));

};

Map.prototype.placeMarkers = function(results){

	var listings = results["results"];

	this.geoJson = [] 

	this.markerLayer = L.mapbox.featureLayer(); 

	// Defining custom HTML for the popups
	this.markerLayer.on('layeradd', function(e){
		var marker = e.layer;
		var photo = marker.feature.properties.image;
		var url = marker.feature.properties.url;
		var popupContent = '<div class="marker-popup"><a href="' + url + '">' + 
							marker.feature.properties.title + '</a><br>' +
							'<img src="' + photo + '"></div>';
		marker.bindPopup(popupContent);
	});

	// object that will be used to map listings to their marker
	this.markerMap = {}

	for (var i = 0; i < listings.length; i++){

		//Current listing
		var listing = listings[i]

		// Define geoJSON for marker and push to geojson list
		this.geoJson.push({
			type: 'Feature',
			"geometry": { 
				"type": "Point", 
				"coordinates": [listing.longitude, listing.latitude]
			},
			"properties": {
				"title": listing.title,
				"image": listing.photo,
				"url": listing.url,
				'marker-size': 'large',
	        	'marker-color': '#00529f',
	        	'marker-symbol': 'bicycle',
	        }
		});

		this.markerMap[listing.id] = i
	}	
	// Add them all to the map 
	this.markerLayer.setGeoJSON(this.geoJson);
	this.markerLayer.addTo(this.map);
	if (!searchParameters.searchOnMapMove){
		this.map.fitBounds(this.markerLayer.getBounds());
	}
}

Map.prototype.setMarkerActive = function(listingId){
	var idx = this.markerMap[listingId];
	this.geoJson[idx].properties["marker-color"] = "#82c2ee";
	this.markerLayer.setGeoJSON(this.geoJson);
	this.markerLayer.addTo(this.map);
};

Map.prototype.setMarkerInactive = function(listingId){
	var idx = this.markerMap[listingId];
	this.geoJson[idx].properties["marker-color"] = "#00529f";
	this.markerLayer.setGeoJSON(this.geoJson);
	this.markerLayer.addTo(this.map);
};

// find out if an item is in a given array
function include(arr,obj) {
    return (arr.indexOf(obj) != -1);
}

// escape user input for display
escapeHTML = function(html) {
  return String(html)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/'/g, '&#x27;')
    .replace(/`/g, '&#x60;')
}

function Listings(el) {

	// events.on('parameter-update', function(){
	// 	// Show loading indicator in searchpanel while results are being fetched
	// 	pass
	// });

	events.on('results-update', function() {
		$searchPanel = $('#search-results')
		$searchPanel.empty()

		// Get the updated search results
		listings = results["results"];

		// Loop through listings in response object
		for (var i = 0; i < listings.length; i++){

			// Current listing
			var listing = listings[i]

			// Create JQuery object for listing title/link
			var $listingLink = $("<a />",{
				href: listing.url,
				text: listing.title 
			});
			
			// Create JQuery object for bike photo	
			var $bikePhoto = $("<div class='img'>")
			$bikePhoto.attr('style','background-image:url("' + listing.photo + '");')
			$bikePhoto.html("<div class='pricetag'>  $" + escapeHTML(listing.price) + "</div>")
			
			var $li = $("<li class='listing-link' data-id='"+ listing.id + "' >");
			$li.append($bikePhoto, $listingLink);

			if (currentUser["id"]!= null){
				var $heartIcon = $("<i class='heart fa fa-heart-o' data-id='" + listing.id + "'></i>");
				if (currentUser.favorites != null && include(currentUser.favorites, listing.id)){
					$heartIcon.removeClass("fa-heart-o");
					$heartIcon.addClass("fa-heart");
				}
				$li.append($heartIcon);
			}			

			$searchPanel.append($li);
		}

		// Triggers marker color change when hovering over listing
		$(".listing-link")
			.on('mouseover', function(){
				var listingId = $(this).data('id');
				events.trigger('listing-mouse-in', listingId);
			})
			.on('mouseout', function(){
				var listingId = $(this).data('id');
				events.trigger('listing-mouse-out', listingId);
			});

		// Adds click listener to hearts and toggles favorite
		$(".heart").on('click', function(){
			var listingId = $(this).data('id');
			$(this).toggleClass("fa-heart-o fa-heart");
			$.post("/favorite", {listing: listingId});
		});
	});

}

function Paginator(el){ 
	var prev = el.querySelector('#prev'); 
	var next = el.querySelector('#next');
	var lower = el.querySelector('#low');
	var upper = el.querySelector('#high');
	var total = el.querySelector('#total');

	// add event listeners to buttons
	$(prev).on('click', function(){
		var page = getParameter('currentPage');
		if (page > 0){
			setParameter('currentPage', page - 1);
		}
		$('html, body').animate({
    		scrollTop: ($('#search-results').offset().top - 125)
		},500);
		events.trigger('parameter-update')
	});

	$(next).on('click', function(){
		var page = getParameter('currentPage');
		setParameter('currentPage', page + 1);
	$('html, body').animate({
    	scrollTop: ($('#search-results').offset().top - 125)
	},500);
		events.trigger('parameter-update') 
	});

	events.on('results-update', function(currentPage){
		$(lower).html(results["pageLower"]);
		$(upper).html(results["pageUpper"]);
		$(total).html(results["totalResults"]);

		// hides prev button on first page
		if (currentPage === 0){
			$(prev).addClass("invisible"); 
			$(".glyphicon-arrow-left").addClass("invisible");
		}
		// shows prev button when page > 1
		if (currentPage > 0){
			$(prev).removeClass("invisible"); 
			$(".glyphicon-arrow-left").removeClass("invisible");
		}
		// shows next button when not on last page
		if (results["pageUpper"] < results["totalResults"]){
			$(next).removeClass("invisible");
			$(".glyphicon-arrow-right").removeClass("invisible");
		}
		// hides next button on last page
		if (results["pageUpper"] === results["totalResults"]){
			$(next).addClass("invisible");
			$(".glyphicon-arrow-right").addClass("invisible");
		}
	});

}

function Filters(el){

	$('#filter-submit').on('click', function(e){

		e.preventDefault();

		var sizeList = []
		// get checked sizes from form
		$('#size-filters input:checked').each(function(i,size){
			sizeList.push($(size).attr('name'));
		});
		setParameter('sizes', sizeList);

		var materialList = []
		// get checked materials from form
		$('#materials-filters input:checked').each(function(i,material){
			materialList.push($(material).attr('name'));
		});
		setParameter('materials', materialList);

		// get min price from slider
		var minPriceValue = $('#range').val()[0];
		setParameter('minPrice', minPriceValue);

		// get max price from form
		var maxPriceValue = $('#range').val()[1];
		setParameter('maxPrice', maxPriceValue);

		// get checked handlebars from slider
		var handlebarList = [];
		$('#handlebar-filters input:checked').each(function(i,handlebar){
			handlebarList.push($(handlebar).attr('name'));
		});

		setParameter('handlebars', handlebarList);
		
		// reset page to 0
		setParameter('currentPage',0)
		events.trigger('parameter-update');
	});

	$('#filter-clear').on('click', function(e){
		e.preventDefault();
		// reset price slider
		$("#range").val([0, 1500]);
		// reset checked fields
		$("input:checked").removeAttr('checked');

		setParameter("sizes", []),
		setParameter("materials", []),
		setParameter("handlebars", []),
		setParameter("maxPrice", null),
		setParameter("minPrice", null),
		setParameter("currentPage",0)
		events.trigger("parameter-update");
	});

	// Price Slider JQuery plugin
	$('#range').noUiSlider({
		start: [0,1500],
		step: 50,
		margin: 20,
		connect: true,
		direction: 'ltr',
		orientation: 'horizontal',
	
		behaviour: 'tap-drag',
		
		format: wNumb({
			mark: '.',
			decimals: 2,
			thousand: ','
		}),
		range: {
			'min': [0],
			'max': [1500]
		}
	});

	// Write price filter values to the min/max value spans
	$('#range').Link('lower').to($('#value-low'), 'html');
	$('#range').Link('upper').to($('#value-high'), 'html');
}

// TODO: function that saves search parameters to URL

// Controller

$(function(){

	// $('#sticky-bar').affix({
 //  		offset: {
 //    		top: $('#sticky-bar').offset().top - 72,
 //  		}
	// });
	
	window.map = new Map(document.querySelector('#map-panel'));
	new Listings(document.querySelector('#search-results'));
	new Paginator(document.querySelector('#paginator'));
	new Filters(document.querySelector('#search-filters'));

	fetchResults(function(data){
		updateResults(data);
	});

});

</script>

{% endblock %} 
