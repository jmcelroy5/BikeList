{% extends 'base.html' %}

{% block scripts %}
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<style>
body{
	margin-left:-53px;
}
#map-panel{
	height: 100%;
	width:570px;
}

#map-panel.affix-top {
    position: absolute;
    margin-top:0px;
    width:570px;
  }

 #map-panel.affix-bottom {
    position: absolute;
    margin-bottom:0px;
    width:570px;
  }

 #map-panel.affix {
    position: fixed;
    top:133px;
    width:570px;
  }

#search-results{
	float:right;
}

#search-results td {
	width: 200px;
}

#search-results img{
	width: 200px;
	margin-bottom: 25px;
}


</style>


<div>
	<div id="map-panel" data-spy="affix" >
		<!-- class="col-md-8" -->
	</div>

	<div id="search-results">

			<!-- Search results will go here -->

	</div>
<!-- 	<nav>
		<ul class="pagination">
			<li><a href="#"><span aria-hidden="true">&laquo;</span><span class="sr-only">Previous</span></a></li>
			<li><a href="#">1</a></li>
			<li><a href="#">2</a></li>
			<li><a href="#">3</a></li>
			<li><a href="#">4</a></li>
			<li><a href="#">5</a></li>
			<li><a href="#"><span aria-hidden="true">&raquo;</span><span class="sr-only">Next</span></a></li>
		</ul>
	</nav> -->
</div>


<script>

	$("#map-panel").affix();

	var displaySearchResults = function(data) {

		// List of listings
		var listings = data['response']

		// Empty search results div
		var resultsDiv = $("#search-results");
		resultsDiv.empty();

		// Clear any markers that are on map 
		if (typeof markerLayer !== 'undefined'){
			markerLayer.clearLayers();
		} 

		// Clear marker list
		markerList = [];

		// Place new markers
		placeMarkers(listings);

		// Load search results table 
		searchResultsTable(listings);
	}

	var searchResultsTable = function(listings){

		// Initializing 2-column search result table
		var numCols = 2;
		var $table = $('<table><tbody><tr>');
		$table.addClass("table");

		// Loop through response object
		for (var i = 0; i < listings.length; i++){

			// Current listing
			var listing = listings[i]

			// Create JQuery object for listing title/link
			var $listingLink = $("<a />",{
				href: listing.url,
				text: listing.title 
			});
			
			// Create JQuery object for bike photo	
			var $bikePhoto = $("<img>")
			$bikePhoto.attr('src', listing.photo)

			// Add to search results table
			var tr = $table.find(">tbody>tr:last");
			if (!tr.length || tr.find(">td").length == numCols){
				var tr = $("<tr>");
				$table.append("<tr>");
			}
			var td = $("<td>");
			td.append($listingLink).append("<br>").append($bikePhoto);
			tr.append(td)
			


		}

		$('#search-results').append($table);
		// $('#search-results').find('td').each( function(){
		// 	$(this).css("height","50px");
		// });      

	}

	function placeMarkers(listings){

		for (var i = 0; i < listings.length; i++){

			//Current listing
			var listing = listings[i]

			// create new marker/layer
			newMarker = L.mapbox.featureLayer(); 

			// Defining custom HTML for marker's popup
			newMarker.on('layeradd', function(e){
				var marker = e.layer;
				var photo = marker.feature.properties.image;
				var url = marker.feature.properties.url;

				var popupContent = '<a href="' + url + '">' + 
									marker.feature.properties.title + '</a><br>' +
									'<img src="' + photo + '">';
				
				marker.bindPopup(popupContent, {
					closeButton: false,
					// minWidth: 280
				});
			});

			// Define geoJSON for new marker
			var geoJson = [{
				type: 'Feature',
				"geometry": { 
					"type": "Point", 
					"coordinates": [listing.longitude, listing.latitude]
				},
				"properties": {
					"title": listing.title,
					"image": listing.photo,
					"url": listing.url,
					'marker-size': 'large',
		        	'marker-color': '#FF6699',
		        	'marker-symbol': 'bicycle'
				}
			}];

			// Set geoJSON
			newMarker.setGeoJSON(geoJson);

			// Add marker to the list
			markerList.push(newMarker);
		}	

		// Create a group for all the markers
		markerLayer = L.layerGroup(markerList)
		// And add them all to the map at once
		markerLayer.addTo(map);
	}

	function loadSearchResults(materials, min_price, max_price, handlebars){
		$.get('/get_all_bikes', {	materials: materials, 
									min_price: min_price, 
									max_price: max_price,
									handlebars: handlebars }, displaySearchResults);
	}

	function initializeMap(){
		//Connect to MapBox API
		L.mapbox.accessToken = "pk.eyJ1Ijoiam1jZWxyb3kiLCJhIjoiVVg5eHZldyJ9.FFzKtamuKHb_8_b_6fAOFg";

		// Initiate map and set view
		map = L.mapbox.map('map-panel', 'examples.map-i86nkdio');
		map.setView([37.79, -122.41], 14);

	}

	function addEventListeners(){

		$('#filter-submit').click(function(e){

			e.preventDefault();

			var materials = [];
			$('#material-filters input:checked').each(function(i,material){
		 		materials.push($(material).attr('name'));
			});

			var min_price_value = $('#search-filters input[name="min_price"').val();
			if (min_price_value.length > 0){
				var min_price = min_price_value
			}
			else{
				var min_price = "";
			}

			var max_price_value = $('#search-filters input[name="max_price"').val();
			if (max_price_value.length > 0){
				var max_price = max_price_value
			}
			else{
				var max_price = "";
			}

			var handlebars = [];
			$('#handlebar-filters input:checked').each(function(i,handlebar){
		 		handlebars.push($(handlebar).attr('name'));
			});

			loadSearchResults(materials, min_price, max_price, handlebars);
		});
	}

	$(document).ready(function(){

		initializeMap();

		loadSearchResults([]);

		addEventListeners();

	});
	

</script>

{% endblock %} 
