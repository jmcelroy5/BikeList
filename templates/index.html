{% extends 'base.html' %}

{% block content %}
<!-- Extend head / custom styles block? -->
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />

<style>
#search-results{
	list-style-type: none
}

#search-results img{
	width: 200px;
}

#map-panel{
	background-color: #69A0CB;
	height: 100%;
}

.leaflet-popup-content img {
  	width: 240px;
  }

.leaflet-popup-content {
  	font-size: 18px;
  	text-align: center;
  }

</style>

<div class="row">
	<div class="col-md-4">
		<ul id="search-results">
			{% for bike in bikes %}
			<li>
				<a href="/listing/{{ bike.id }}"> <h4> {{ bike.title }} </h4> </a>
				<p> ${{ bike.listings[0].asking_price }}</p>
				<img src="{{ bike.photo }}"> 
			</li><br>
			{% endfor %}
		</ul>
	</div>
	<div id="map-panel" class="col-md-8">

	</div>
</div>

<script>
	L.mapbox.accessToken = "pk.eyJ1Ijoiam1jZWxyb3kiLCJhIjoiVVg5eHZldyJ9.FFzKtamuKHb_8_b_6fAOFg";

	var map = L.mapbox.map('map-panel', 'examples.map-i86nkdio');
	map.setView([37.79, -122.41], 14);

	$.get('/get_all_bikes', function(data){

		for (var i = 0; i < data['response'].length; i++){

			// Current listing
			var listing = data['response'][i];

			var newLayer = L.mapbox.featureLayer().addTo(map);

			// Creating geoJSON object for marker
			var geoJson = [{
					type: 'Feature',
					"geometry": { 
						"type": "Point", 
						"coordinates": [listing.longitude, listing.latitude]
					},
					"properties": {
						"title": listing.title,
						"image": listing.photo,
						"url": listing.url,
						"price": listing.price,
						'marker-size': 'large',
			        	'marker-color': '#FF6699',
			        	'marker-symbol': 'bicycle'
					}
			}];

			// Adding custom HTML popup to marker
			newLayer.on('layeradd', function(e){
				var marker = e.layer;
				var photo = marker.feature.properties.image;
				var url = marker.feature.properties.url;

				var popupContent = '<a href="' + url + '">' + listing.title + '</a><br>' +
									'<img src="' + photo + '">';
				
				marker.bindPopup(popupContent,{
        			closeButton: false,
        			// minWidth: 280
    			});
			});

			newLayer.setGeoJSON(geoJson);
		}
	});

</script>

{% endblock %} 
